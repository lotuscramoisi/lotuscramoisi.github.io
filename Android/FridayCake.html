<!DOCTYPE html>
<html lang="en">
<link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.css" rel="stylesheet" />
<script src="../assets/js/prism.js"></script>
<script src="../assets/js/prism-javascript.min.js"></script>
<script src="../assets/js/prism-bash.min.js"></script>

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CTF Writeup</title>
<style>
:root {
  --bg:#0e0f13; --fg:#e6e6e6; --muted:#9aa0a6;
  --accent:#7dd3fc; --edge:#3b4252; --node:#a78bfa;
  --badge:#1f2937; --highlight:#facc15;
  --color-code-background:#111318; --color-link:#7dd3fc;
  --highlight-foreground:#60a5fa; --highlight-nav:#7dd3fc33;
  --cursor-pointer:pointer; --global-theme:#f472b6;
}
.home-btn { text-decoration: none; color: var(--accent); background: var(--badge); padding: 6px 12px; border-radius: 6px; border: 1px solid var(--edge); font-weight: bold; transition: 0.3s; }
.home-btn:hover { background: var(--accent); color: var(--bg); }
body{margin:0;font-family:ui-sans-serif,system-ui;background:var(--bg);color:var(--fg)}
header{padding:16px;border-bottom:1px solid #1f2430;display:flex;align-items:center;justify-content:space-between;background:#111318}
h1{margin:0;font-size:24px}
.container{display:grid;grid-template-columns:1fr 360px;gap:16px;padding:16px}
aside{border-left:1px solid #1f2430;padding:16px;overflow-y:auto;background:#111318;box-shadow:-2px 0 8px rgba(0,0,0,0.3)}
.post{padding:12px;border:1px solid #232838;border-radius:10px;margin-bottom:12px;background:#181b22;box-shadow:0 2px 6px rgba(0,0,0,0.35)}
.post h4{margin:0 0 6px 0}.post .meta{font-size:12px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap}
.badge{font-size:14px;background:var(--badge);padding:6px 10px;margin-right:10px;border-radius:6px;border:1px solid #2b3242}
.article-entry{margin-bottom:24px}
.article-entry code,.article-entry kbd{font-family:'JetBrains Mono','Menlo','Monaco','Consolas','monospace';font-size:95%;transition:0.3s;word-break:break-word;background:var(--color-code-background);padding:1px 5px;border-radius:5px;color:var(--color-link)}
.article-entry pre[class*="language-"]{ background: var(--color-code-background) !important; border-radius:0}
.article-entry pre code{background:none;text-shadow:none;color:var(--fg);padding:0}
.article-entry .highlight{overflow:hidden;interpolate-size:allow-keywords}
.article-entry .highlight.code-closed pre{height:0;opacity:0;overflow:hidden}
.code-area{width:100%;overflow:hidden;transition:0.3s;border-radius:10px;border:2px solid #232838;background:#111318;margin-bottom:16px}
.code-figcaption{width:100%;display:flex;justify-content:space-between;height:40px;align-items:center;flex-shrink:0;background:linear-gradient(to right, transparent 0%, var(--bg) 50%, transparent 100%);margin-bottom:10px;padding:0 8px;position:relative}
.code-left-wrap,.code-right-wrap{display:flex;align-items:center}
.code-copy,.code-lang,.code-expand{margin:5px; padding-right: 12px; z-index:1;filter:invert(50%);cursor:var(--cursor-pointer);color:#fff;transition:0.3s}
.code-copy:hover,.code-expand:hover{opacity:.7}
.code-expand{transform:rotate(0deg)}
.code-closed .code-expand{transform:rotate(-180deg)!important;transition:0.3s}
</style>
</head>
<body>
<header>
  <a href="../index.html" class="home-btn">Home</a>
  <h1>FridayCake</h1>
  <div id="current-legend"><span class="badge">Mobile</span></div>
</header>
<div class="container">
  <main class="article-entry">
    <section>
      This is a medium difficulty challenge done during BrunnerCTF
      <h2>Introduction</h2>
        <div>
            <img src="../assets/images/FridayCakeIntro.PNG">
        </div>
    </section>
    <section>
      <h2>Setup</h2>
      <p>For mobile challenges, I usually decompile the APK with APKToolGUI and analyze the code using Jadx-gui.</p>
      <p>Using this method I found that the MainActivity check if a certain string has been loaded in order to unlock a safe. </p>
      <div>
        <img src="../assets/images/FridayCakeMain.PNG">
      </div>
      <p>The string comes from the a method called NativeChecker and load the password of the application using System.loadLibrary("native-lib")</p>
      <div>
        <img src="../assets/images/FridayCakeFunction.PNG">
      </div>
      <h2>Exploit</h2>
      <p>Because I don't want to transform this into a reverse challenge where I decompile the nativ-lib (And wanted to respect the challenge name). I will use frida to call the "getDecryptedFlag" function </p>
      <p>If you have never use frida here are the small steps to have something working:</p>
      <ol>
        <li>Using Android Studio, create a running device (Tools/DeviceManager) and create a virtual device manager that DOESN'T have access to the playstore using the version of APK you want.</li>
        <li>Once download and started, download the frida server for Android (server x84_64): https://github.com/frida/frida/releases</li>
        <li>adb root</li>
        <li>adb push frida-server-version /data/local/tmp/frida_server</li>
        <li>Run using: ./frida-server-version &</li>
      </ol>
      <p>Using that, frida server will be running on the phone and we will be able to modify the behavior of the application.  </p>
      <div>
        <img src="../assets/images/FridayCakeAndroidStudio.png">
      </div>
      <p>Here is the small snipet of code that will retrive the password using the "getDecryptedFlag" function:</p>
      <div class="code-area">
        <div class="code-figcaption">
          <div class="code-left-wrap"><span class="code-lang">JS</span></div>
          <div class="code-right-wrap"><span class="code-copy">Copy</span></div>
        </div>
        <pre><code class="language-javascript">Java.perform(function () {
    var NativeChecker = Java.use("dk.brunnerctf.fridaycake.NativeChecker");

    var flag = NativeChecker.INSTANCE.value.getDecryptedFlag();
    console.log("[*] getDecryptedFlag() returned: " + flag);
});
</code></pre>
      </div>
    </section>
    <p>The small function call be called using the following:</p>
    <div class="code-area">
        <div class="code-figcaption">
          <div class="code-left-wrap"><span class="code-lang">JS</span></div>
          <div class="code-right-wrap"><span class="code-copy">Copy</span></div>
        </div>
        <pre><code class="language-bash">frida -U -f dk.brunnerctf.fridaycake -l hook.js</code></pre>
      </div>
    <div>
        <img src="../assets/images/FridaCakeSolution.PNG">
      </div>
  </main>
  <aside>
    <h3>Related Writeups</h3>
    <div id="related-posts">
      <div class="post"><h4><a href="../Android/FireintheBaseCamp.html" style="color: var(--global-theme); text-decoration: none;">Fire in the base camp</a></h4><div class="meta"><span>2024-10-06</span><span class="badge" style="background:#60a5fa22;border-color:#60a5fa55">Mobile</span></div></div>
    </div>
  </aside>
</div>
</body>
</html>


<script>
document.querySelectorAll('.code-copy').forEach(btn => {
  btn.addEventListener('click', () => {
    const codeArea = btn.closest('.code-area');
    if (!codeArea) return;

    const codeBlock = codeArea.querySelector('pre code');
    if (!codeBlock) return;

    navigator.clipboard.writeText(codeBlock.innerText).then(() => {
      btn.textContent = 'Copied!';
      setTimeout(() => btn.textContent = 'Copy', 1500);
    }).catch(err => console.error('Failed to copy text: ', err));
  });
});
</script>
